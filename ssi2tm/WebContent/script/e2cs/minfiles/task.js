Ext.ECalendar.daytask=function(config){this.renderdatatoUse=[];this.previndex=0;this.createdelementno=0;this.editable=true;this.parentview=null;this.baseBody=null;this.datehandle=new Date();this.showQtip=true;this.tasksOffset=5;this.task_id=0;this.task_index=0;this.task_subject='';this.task_starts='';this.task_ends='';this.task_description='';this.task_zhr='';this.task_clsOver='';this.task_increment=5;this.task_width=100;this.forceTaskFit=false;this.totalTasksonView=0;this.customHtml='';this.customHTMLinpos='before';this.bgcolor='#E0FFA2';this.task_format='d-m-Y H:i:s a';this.moreMenuItems=[];this.contextMenuLabels=e2cs.cal_locale.contextMenuLabelsDay;this.task_useBxStyle=false;this.task_useBxcolor='#225588';this.tplqTip=new Ext.XTemplate('<tpl for=".">{starxl}{startval}<br>{endxl}{endval}<hr color="#003366" noshade>{details}</tpl>');this.ShowMenuItems=[1,1,1,1,1];this.evenLaunch='dblclick';this.scale=0;Ext.apply(this,config);Ext.ECalendar.daytask.superclass.constructor.call(this)};Ext.extend(Ext.ECalendar.daytask,Ext.util.Observable,{init:function(calendar,dayview){this.calx=calendar;this.vday=dayview},render:function(){var scalepx=(this.scale==0)?60:30;var m_starttime=this.calx.currentdate.format('m/d/Y ')+this.vday.startTime;var m_endtime=this.calx.currentdate.format('m/d/Y ')+this.vday.endTime;this.totalhours=this.calx.dateDiff(new Date(m_starttime),new Date(m_endtime),e2cs.dateParts.HOUR);var inittimetask=this.checkTasktime(this.task_starts);var endtimetask=this.checkTasktime(this.task_ends);var checkbetwdate=this.calx.currentdate.between(new Date(m_starttime),new Date(m_endtime));var diffstartinipos=this.calx.dateDiff(new Date(m_starttime),new Date(inittimetask),e2cs.dateParts.MINUTE);if(diffstartinipos<0){initpos=0;flagstarttasttext=e2cs.cal_locale.task_LessDaysFromTask}else{initpos=(this.scale==0)?diffstartinipos:(diffstartinipos/2);flagstarttasttext=''}var diffendpos=this.calx.dateDiff(new Date(m_endtime),new Date(endtimetask),e2cs.dateParts.MINUTE);diffendpos=(this.scale==0)?diffendpos:(diffendpos/2);var testdiff=new Date(endtimetask).add(Date.SECOND,-1);var diffposxb=this.calx.dateDiff(testdiff,new Date(m_endtime),e2cs.dateParts.SECOND);diffposxb=(this.scale==0)?diffposxb:(diffposxb/2);if(diffendpos>0&&diffposxb!=0){endpos=(this.totalhours)*60;endpos=(this.scale==0)?endpos:(endpos/2);endpos=Math.abs(initpos-endpos);flagendtasttext=e2cs.cal_locale.task_MoreDaysFromTask}else{var tmpdate=new Date(inittimetask);var dtstartday=new Date(this.calx.currentdate.format('m/d/Y')+' '+this.vday.startTime);if(tmpdate<dtstartday){endpos=this.calx.dateDiff(new Date(m_starttime),new Date(endtimetask),e2cs.dateParts.MINUTE)}else{endpos=this.calx.dateDiff(new Date(inittimetask),new Date(endtimetask),e2cs.dateParts.MINUTE)}endpos=(this.scale==0)?endpos:endpos/2;if(endpos<0){return}flagendtasttext=''}if(this.customHtml==null||this.customHtml==undefined){var Bfhtmlins='';var Afhtmlins=''}else{if(this.customHTMLinpos=='before'){var Bfhtmlins=this.customHtml;var Afhtmlins=''}else if(this.customHTMLinpos=='after'){var Bfhtmlins='';var Afhtmlins=this.customHtml}else{var Bfhtmlins='';var Afhtmlins=''}}this.task_index=(this.vday.tasks.length);if(this.forceTaskFit){this.taskobject=this.baseBody.createChild({tag:'div',cls:'task',html:Bfhtmlins+flagstarttasttext+this.task_subject+flagendtasttext+Afhtmlins})}else{this.taskobject=this.baseBody.createChild({tag:'div',cls:'task',html:Bfhtmlins+flagstarttasttext+this.task_subject+flagendtasttext+Afhtmlins})}this.taskobject.dom.setAttribute('id',this.calx.id+'-ecaltask-'+this.task_index+'');this.taskobject.dom.setAttribute('ec_id',''+this.task_id+'');this.taskobject.dom.setAttribute('ec_starts',''+inittimetask+'');this.taskobject.dom.setAttribute('ec_ends',''+endtimetask+'');this.taskobject.dom.setAttribute('ec_subject',''+this.task_subject+'');this.taskobject.dom.setAttribute('ec_cnt',''+this.task_description+'');this.taskobject.dom.setAttribute('ec_storeindex',''+this.task_index+'');this.taskobject.dom.setAttribute('ec_zbr',''+this.task_zbr+'');if(this.forceTaskFit){this.taskobject.setStyle({top:''+initpos+'px'});this.taskobject.setStyle({height:''+endpos+'px'});this.taskobject.setStyle({position:'absolute'});var datarenderthis=null;for(var i=0;i<this.renderdatatoUse.length;i++){if(this.renderdatatoUse[i].taskid==this.task_id){datarenderthis=this.renderdatatoUse[i]}}if(datarenderthis!=null){this.taskobject.setStyle({width:''+datarenderthis.ancho+'%'});if(Ext.version.substr(0,1)=="3"){this.taskobject.applyStyles('left:'+datarenderthis.left+'%;')}else{this.taskobject.setStyle({left:''+datarenderthis.left+'%'})}}else{var overlapping=this.calx.getOtherTasksWx(this.allDayTasks,this.task_subject,new Date(inittimetask),new Date(endtimetask));if(overlapping.number>1){this.taskobject.setStyle({width:''+99/overlapping.number+'%'});if(Ext.version.substr(0,1)=="3"){this.taskobject.applyStyles('left:'+overlapping.taskIdx+'%;')}else{this.taskobject.setStyle({left:''+overlapping.taskIdx+'%'})}}else{this.taskobject.setStyle({width:'100%'});if(Ext.version.substr(0,1)=="3"){this.taskobject.setLeft(''+overlapping.taskIdx+'%')}else{this.taskobject.setStyle({left:''+overlapping.taskIdx+'%'})}}}var test=11}else{this.taskobject.setStyle({top:''+initpos+'px'});if(this.task_useBxStyle){this.taskobject.setStyle({border:'1px solid '+this.task_useBxcolor+''});if(Ext.isIE){this.taskobject.setStyle({height:''+(endpos)+'px'});this.taskobject.setStyle({width:''+(this.task_width)+'px'})}else{this.taskobject.setStyle({height:''+(endpos-2)+'px'});this.taskobject.setStyle({width:''+(this.task_width-2)+'px'})}}else{this.taskobject.setStyle({height:''+(endpos)+'px'});this.taskobject.setStyle({width:''+(this.task_width)+'px'})}if(this.tasksOffset=='auto'){if(this.task_index<=1){var anchoposx=0}else{tmpoffset=this.task_width;anchoposx=0;for(var x=0;x<=(this.vday.tasks.length-1);x++){if(x!=0){anchoposx+=Ext.get(this.calx.id+'-ecaltask-'+(x)).getWidth(false)}}}}else{var anchoposx=0;if(this.task_index<=1){var tmpoffset=0}else{tmpoffset=this.tasksOffset;this.taskobject.setStyle('margin-left',(tmpoffset)+'px')}}newancho=0;for(var x=0;x<=(this.vday.tasks.length);x++){if(x!=0){newancho+=Ext.get(this.calx.id+'-ecaltask-'+(x)).getWidth(false)}}if(newancho>this.baseBody.getWidth(false)){Ext.get(this.calx.id+'-daybody').setWidth(newancho);Ext.get('tdbaseday').setWidth(newancho)}if(Ext.isOpera){}else{}}if(this.bgcolor){this.taskobject.setStyle('background-color',''+this.bgcolor+'')}else{this.taskobject.setStyle('background-color','#99CC99')}if(Ext.isIE){this.taskobject.setStyle('z-index','3001')}else{this.taskobject.setStyle('z-index','auto')}if(this.showQtip){var tmpdate=new Date(inittimetask);var startlabel=tmpdate.format(this.task_format);tmpdate=new Date(endtimetask);var endlabel=tmpdate.format(this.task_format);this.taskobject.dom.qtitle=this.task_subject;if(this.task_description==''){var desctmp=' <br/> '}else{var desctmp=this.task_description}var datatip={starxl:e2cs.cal_locale.task_qtip_starts,startval:startlabel,endxl:e2cs.cal_locale.task_qtip_ends,endval:endlabel,details:desctmp,zbr:this.task_zbr,subject:this.task_subject};this.taskobject.dom.qtip=this.tplqTip.apply(datatip)}if(this.task_clsOver!=''){this.taskobject.addClassOnOver(this.task_clsOver)}this.taskobject.addListener(this.evenLaunch,this.onDblclick,this);if(Ext.isOpera){this.taskobject.addListener('mousedown',this.operabuttons,this)}else{this.taskobject.on('contextmenu',this.oncontextmenu,this,{stopPropagation:true,stopEvent:true,normalized:true,preventDefault:false})}if(initpos==0&&endpos>(this.totalhours*scalepx)){}else{if(this.editable){if(flagendtasttext==''){if(Ext.isIE){var checkie_pinned=true}else{var checkie_pinned=false}var snap=new Ext.Resizable(this.calx.id+'-ecaltask-'+this.task_index+'',{pinned:checkie_pinned,width:this.task_width,handles:'s',heightIncrement:this.task_increment,minHeight:15,maxHeight:((this.totalhours*scalepx)-initpos),dynamic:true,draggable:true});var tmpbody=this.baseBody;var tmpvday=this.vday;var tmptask=this;var tmpcalendar=this.calx;snap.on({'resize':{fn:function(objthis,width,height,evtObj){var datatask=tmptask.getTaskarray(objthis.el);var check=tmpcalendar.fireEvent("beforeTaskMove",datatask,tmptask,tmpvday,tmpcalendar);if(check){tmptask.applyChange(objthis.el);var newdatatask=tmptask.getTaskarray(objthis.el);tmpcalendar.fireEvent("TaskMoved",newdatatask,tmptask,tmpvday,null)}},scope:this}});if(flagstarttasttext==''&&flagendtasttext==''){var taskdrag=new Ext.dd.DDProxy(this.calx.id+'-ecaltask-'+this.task_index+'','task-group',{xTicks:0,yTicks:5});var tmpbody=this.baseBody;var tmpvday=this.vday;var tmptask=this;var tmpcalendar=this.calx;taskdrag.startDrag=function(){this.constrainTo(tmpbody.id);this.setXConstraint(0,0,0);var dragEl=Ext.get(this.getDragEl());var el=Ext.get(this.getEl());dragEl.applyStyles({border:'','z-index':3600});dragEl.update(el.dom.innerHTML);dragEl.addClass('task-drag'+' dd-proxy')};taskdrag.endDrag=function(){var dragEl=Ext.get(this.getDragEl());var el=Ext.get(this.getEl());var domel=Ext.get(this.handleElId);var datatask=tmptask.getTaskarray(domel);var check=tmpcalendar.fireEvent("beforeTaskMove",datatask,tmptask,tmpvday,tmpcalendar);if(check){el.setY(dragEl.getY());tmptask.applyChange(domel);var newdatatask=tmptask.getTaskarray(domel);tmpcalendar.fireEvent("TaskMoved",newdatatask,tmptask,tmpvday,this)}else{}}}}}}},operabuttons:function(evx,elx,obx){if(Ext.isOpera){if(evx.button==2){this.oncontextmenu(evx,elx,obx)}}},oncontextmenu:function(evx,elx,obx){if(Ext.isOpera){if(evx.button!=2){return false}}if(this.ShowMenuItems[0]!=true&&this.ShowMenuItems[1]!=true&&this.ShowMenuItems[2]!=true&&this.ShowMenuItems[3]!=true&&this.ShowMenuItems[4]!=true&&this.moreMenuItems.length<=0){return false}if(Ext.version.substr(0,1)=="2"){evx.stopEvent()}if(elx.id.indexOf(this.calx.id+'-ecaltask-')<0){var tmpdata=Ext.get(elx.parentNode.id)}else{var tmpdata=Ext.get(elx.id)}var dataTASKtmp=this.getTaskarray(tmpdata);var newmenuitems=this.vday.moreMenuItems;var toshowOnCXmenu=this.ShowMenuItems;var actionsTaskCX=[];var testevent=this.calx.fireEvent("beforeContextMenuTask","dayview-task",dataTASKtmp,toshowOnCXmenu,actionsTaskCX);if(testevent==false){if(actionsTaskCX[0]==false){if(actionsTaskCX[1]==true){if(actionsTaskCX[2]==true){var newmenuitems=actionsTaskCX[3]}var toshowOnCXmenu=actionsTaskCX[4]}else{var newmenuitems=this.vday.moreMenuItems;var toshowOnCXmenu=this.ShowMenuItems}}else{return false}}else{var newmenuitems=this.vday.moreMenuItems}if(this.menu){this.menu.removeAll()}this.menu=new Ext.menu.Menu({allowOtherMenus:true,shadow:false,items:[{id:'day_ctxbtn_task-add',iconCls:'x-calendar-day-btnmv_add',text:this.contextMenuLabels.taskAdd,scope:this},{id:'month_ctxbtn_task-delete',iconCls:'x-calendar-day-btnmv_delete',text:this.contextMenuLabels.taskDelete,scope:this},'-',{id:'month_ctxbtn_task-edit',iconCls:'x-calendar-day-btnmv_task',text:this.contextMenuLabels.taskEdit+tmpdata.getAttributeNS('tag','ec_subject'),scope:this},'-',{id:'month_ctxbtn_task-go-nd',iconCls:'x-calendar-day-btnmv_nextday',text:this.contextMenuLabels.NextDay,scope:this},{id:'month_ctxbtn_task-go-pd',iconCls:'x-calendar-day-btnmv_prevday',text:this.contextMenuLabels.PreviousDay,scope:this}]});if(newmenuitems.length>0){this.menu.add('-');for(var i=0;i<newmenuitems.length;i++){newmenuitems[i].rendered=false;if(newmenuitems[i].menu==undefined){newmenuitems[i].rendered=false;if(newmenuitems[i].ctype=="Ext.menu.Item"){if(newmenuitems[i].hasListener('click')){newmenuitems[i].purgeListeners()}newmenuitems[i].addListener('click',function(parx,parz){this.onCustomMenuAction(parx.id,Ext.get(elx),this)},this)}else{}this.menu.add(newmenuitems[i])}else{newmenuitems[i].menu.rendered=false;for(var xm=0;xm<newmenuitems[i].menu.items.length;xm++){newmenuitems[i].menu.items.items[xm].rendered=false;if(newmenuitems[i].menu.items.items[xm].ctype=="Ext.menu.Item"){if(newmenuitems[i].menu.items.items[xm].hasListener('click')){newmenuitems[i].menu.items.items[xm].purgeListeners()}newmenuitems[i].menu.items.items[xm].addListener('click',function(parx,parz){this.onCustomMenuAction(parx.id,Ext.get(elx),this)},this)}else{}}this.menu.add(newmenuitems[i])}}}this.menu.items.items[0].addListener('click',function(){this.onActionTask(1,Ext.get(elx),this)},this);this.menu.items.items[1].addListener('click',function(){this.onActionTask(2,Ext.get(elx),this)},this);this.menu.items.items[3].addListener('click',function(){this.onActionTask(3,Ext.get(elx),this)},this);this.menu.items.items[5].addListener('click',function(){this.vday.onclicknext_day()},this);this.menu.items.items[6].addListener('click',function(){this.vday.onclickprev_day()},this);if(toshowOnCXmenu[0]!=true){this.menu.items.items[0].hidden=true}if(toshowOnCXmenu[1]!=true){this.menu.items.items[1].hidden=true}if(toshowOnCXmenu[0]!=true&&toshowOnCXmenu[1]!=true){this.menu.items.items[2].hidden=true}if(toshowOnCXmenu[2]!=true&&toshowOnCXmenu[3]!=true&toshowOnCXmenu[4]!=true&newmenuitems.length<=0){this.menu.items.items[2].hidden=true}if(toshowOnCXmenu[2]!=true){this.menu.items.items[3].hidden=true;this.menu.items.items[4].hidden=true}if(toshowOnCXmenu[3]!=true&&toshowOnCXmenu[4]!=true&newmenuitems.length<=0){this.menu.items.items[4].hidden=true}if(toshowOnCXmenu[3]!=true){this.menu.items.items[5].hidden=true}if(toshowOnCXmenu[4]!=true){this.menu.items.items[6].hidden=true}if(newmenuitems.length>0){if(toshowOnCXmenu[3]!=true&&toshowOnCXmenu[4]!=true){this.menu.items.items[7].hidden=true}}this.menu.on('hide',this.onContextTaskMenuHide,this);if(Ext.version.substr(0,1)=="2"){this.menu.on('hide',this.onContextTaskMenuHide,this);this.menu.showAt([evx.getPageX(),evx.getPageY()])}else{this.menu.on('hide',this.onContextTaskMenuHideNewEXT,this);this.menu.showAt([evx.clientX,evx.clientY])}},onContextTaskMenuHideNewEXT:function(obj){if(Ext.version.substr(0,1)=="3"){obj.removeAll();obj.destroy()}},onContextTaskMenuHide:function(){},onCustomMenuAction:function(MenuId,taskEl,TaskObj){var datatask=this.getTaskarray(taskEl);this.calx.fireEvent("customMenuAction",MenuId,'day',datatask,taskEl,this.vday);this.menu.hide()},applyChange:function(TaskEl){var datael=this.getTaskarray(TaskEl);var initdate=new Date(datael[3]);var m_starttime=this.calx.currentdate.format('m/d/Y ')+this.vday.startTime;var m_endtime=this.calx.currentdate.format('m/d/Y ')+this.vday.endTime;var tmpEl=Ext.get(TaskEl.id);if(initdate<new Date(m_starttime)){var minutesmbefore=this.calx.dateDiff(initdate,new Date(m_starttime),e2cs.dateParts.MINUTE);var newposstart=0;var newposend=tmpEl.getHeight();newposend=(this.hourScale==0)?newposend:newposend*2;var newdateTaskstart=new Date(initdate).add(Date.MINUTE,(minutesmbefore+newposstart));var newdateTaskEnds=newdateTaskstart.add(Date.MINUTE,newposend)}else{var newposstart=Math.abs(tmpEl.getTop()-Ext.get(this.baseBody).getY());newposstart=(this.hourScale==0)?newposstart:newposstart*2;var newposend=tmpEl.getHeight();newposend=(this.hourScale==0)?newposend:newposend*2;var newdateTaskstart=new Date(m_starttime).add(Date.MINUTE,newposstart);var newdateTaskEnds=newdateTaskstart.add(Date.MINUTE,newposend)}tmpEl.dom.setAttribute('ec_starts',''+newdateTaskstart.format('m/d/Y H:i:s')+'');tmpEl.dom.setAttribute('ec_ends',''+newdateTaskEnds.format('m/d/Y H:i:s')+'');if(this.showQtip){var startlabel=newdateTaskstart.format(this.task_format);var endlabel=newdateTaskEnds.format(this.task_format);tmpEl.dom.qtip=e2cs.cal_locale.task_qtip_starts+startlabel+"<br>"+e2cs.cal_locale.task_qtip_ends+endlabel+'<br>'+this.task_description}},onActionTask:function(action,taskEl,TaskObj){var datatask=this.getTaskarray(taskEl);switch(action){case 1:this.calx.fireEvent("taskAdd",this.calx.currentdate);break;case 2:var check=this.calx.fireEvent("beforeTaskDelete",datatask,this.vday);if(check){if(this.calx.fireEvent("onTaskDelete",datatask)==true){this.calx.fireEvent("afterTaskDelete",datatask,true)}else{this.calx.fireEvent("afterTaskDelete",null,false)}}break;case 3:var check=this.calx.fireEvent("beforeTaskEdit",datatask,this.vday);if(check){if(this.calx.fireEvent("onTaskEdit",datatask)==true){this.calx.fireEvent("afterTaskEdit",datatask,true)}else{this.calx.fireEvent("afterTaskEdit",null,false)}}break;default:break}},onDblclick:function(evx,elx,obx){if(elx.id.indexOf(this.calx.id+'-ecaltask-')<0){var tmpdata=Ext.get(elx.parentNode.id)}else{var tmpdata=Ext.get(elx.id)}var datatask=this.getTaskarray(tmpdata);this.calx.fireEvent("taskDblClick",datatask,this.vday,this.calx,'day')},getTaskarray:function(TaskElx){var tmpdata=Ext.get(TaskElx);var datatask=[];datatask[0]=tmpdata.getAttributeNS('tag','id');datatask[1]=tmpdata.getAttributeNS('tag','ec_storeindex');datatask[2]=tmpdata.getAttributeNS('tag','ec_id');datatask[3]=tmpdata.getAttributeNS('tag','ec_starts');datatask[4]=tmpdata.getAttributeNS('tag','ec_ends');datatask[5]=tmpdata.getAttributeNS('tag','ec_zbr');datatask[6]=tmpdata.getAttributeNS('tag','ec_subject');datatask[7]=tmpdata.getAttributeNS('tag','ec_cnt');return datatask},checkTasktime:function(taskvalue){if(taskvalue instanceof Date){var tochecktmpdt=taskvalue.format('m/d/Y G:i')}else{var tochecktmpdt=taskvalue}var test=tochecktmpdt.indexOf(":",0);if(test<=0){taskvaluefix=tochecktmpdt+' '+this.vday.startTime}else{taskvaluefix=tochecktmpdt}return taskvaluefix},getTaskObject:function(){return this.taskobject}});
