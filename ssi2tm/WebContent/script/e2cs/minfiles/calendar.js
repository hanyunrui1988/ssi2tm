Ext.namespace('e2cs.dateParts');e2cs.dateParts={YEAR:0,MONTH:1,DAY:2,HOUR:3,MINUTE:4,SECOND:5,MILLISECOND:6,QUARTER:7,WEEK:8,WEEKDAY:9};Ext.Ecalendar=function(a){this.id=Ext.id();this.title='';this.mytitle='';this.html=null;this.header=true;this.showCal_tbar=true;this.showRefreshbtn=true;this.refreshAction='view';this.currentView='month';this.currentdate=new Date();this.dateSelector=false;this.dateSelectorIcon='';this.dateformat='d-m-Y';this.fieldsRefer={id:'',subject:'',description:'',color:'',startdate:'',enddate:'',priority:'',html:'',zbr:''};this.tipmaxLength=100;this.rendertaskonHolidays=false;this.storeOrderby='';this.storeOrder='ASC';this.tplTaskTip=new Ext.XTemplate('<tpl for=".">{zbr}{starxl}{startval}<br>{endxl}{endval}<hr color=\'#003366\' noshade>{details}</tpl>');this.tplTaskZoom=new Ext.XTemplate('<tpl for=".">','<div class="ecal-show-basetasktpl-div">Task:{subject}<br />','Zbr:{zbr}<br />','Starts:{startdate}<br />Ends:{enddate}<br>Description:<br>{description}<div><hr>','</tpl>');this.monitorBrowserresize=false;this.iconToday='';this.mview=null;this.iconMonthView='';this.wview=null;this.iconWeekView='';this.dview=null;this.iconDayView='';this.sview=null;this.iconSchedView='';this.store=null;this.pickerStartDay=0;this.viewmonth=null;this.viewday=null;this.viewweek=null;this.viewscheduler=null;this.viewready=false;this.loadMask=true;this.customMaskText='';this.calendarMask=null;Ext.ECalendar.superclass.constructor.call(this,a)};Ext.ECalendar=Ext.extend(Ext.Ecalendar,Ext.Panel,{initComponent:function(){this.addEvents('onRefresh','beforeChangeView','onChangeView','beforeChangeDate','afterChangeDate','beforeContextMenuTask','customMenuAction','taskAdd','taskDblClick','beforeTaskMove','TaskMoved','beforeTaskDelete','onTaskDelete','afterTaskDelete','beforeTaskEdit','onTaskEdit','afterTaskEdit');if(this.html!=null){this.html=null}toolspanel=[];this.btnrefresh={id:'refresh',tooltip:'Actualizar contenido'};if(this.showRefreshbtn){toolspanel.push(this.btnrefresh)}this.btn_today={id:this.id+'-btn_settoday',cls:'x-btn-text-icon',text:e2cs.cal_locale.todayLabel,icon:this.iconToday,tooltip:e2cs.cal_locale.todayToolTip};this.btn_monthviewchange={id:this.id+'-btn_monthview',cls:'x-btn-icon',text:'',icon:this.iconMonthView,tooltip:e2cs.cal_locale.tooltipMonthView};this.btn_weekviewchange={id:this.id+'-btn_weekview',cls:'x-btn-icon',text:'',icon:this.iconWeekView,tooltip:e2cs.cal_locale.tooltipWeekView};this.btn_dayviewchange={id:this.id+'-btn_dayview',cls:'x-btn-icon',text:'',icon:this.iconDayView,tooltip:e2cs.cal_locale.tooltipDayView};this.btn_schedviewchange={id:this.id+'-btn_sched_view',cls:'x-btn-icon',text:'',icon:this.iconSchedView,tooltip:e2cs.cal_locale.tooltipSchedView};if(this.showCal_tbar){this.tbar_calendar=new Ext.Toolbar({id:this.id+'-cmscalendartoolbar',autoWidth:true,autoHeight:false,items:[this.btn_today,'-',this.btn_monthviewchange,this.btn_weekviewchange,this.btn_dayviewchange,this.btn_schedviewchange,'-']})}else{this.tbar_calendar=null}this.selector_dateMenu=new Ext.menu.DateMenu({defaultAlign:'tr-br',subMenuAlign:''});if(this.width){var_autoWidth=false}else{var_autoWidth=true}if(this.height){var_autoHeight=false}else{var_autoHeight=true}Ext.apply(this,{header:this.header,headerAsText:true,title:this.title+this.mytitle,border:true,width:this.width,height:this.height,monitorResize:true,autoShow:true,autoWidth:var_autoWidth,autoHeight:var_autoHeight,autoScroll:false,html:this.html,tools:toolspanel,tbar:this.tbar_calendar,loadMask:this.loadMask});Ext.ECalendar.superclass.initComponent.call(this);if(this.mview){this.viewmonth=this.getViewMonth();this.viewmonth.init(this,this.currentdate)}if(this.dview){this.viewday=this.getViewDay();this.viewday.init(this,this.currentdate)}if(this.wview){this.viewweek=this.getViewWeek();this.viewweek.init(this,this.currentdate)}if(this.sview){this.viewscheduler=this.getViewShedule();this.viewscheduler.init(this,this.currentdate)}},onResize:function(){Ext.ECalendar.superclass.onResize.apply(this,arguments);this.doLayout();if(this.viewready){if(this.currentView=='month'){this.viewmonth.render()}if(this.currentView=='week'){this.viewweek.render()}if(this.currentView=='day'){this.viewday.render()}if(this.currentView=='schedule'){this.viewscheduler.render()}}},onRender:function(){Ext.ECalendar.superclass.onRender.apply(this,arguments)},afterRender:function(){Ext.ECalendar.superclass.afterRender.call(this);if(this.loadMask){if(this.store==null&&this.store==undefined){}else{if(this.customMaskText==''){var a=e2cs.cal_locale.loadmaskText}else{var a=this.customMaskText}this.calendarMask=new Ext.LoadMask(Ext.get(this.id),{msg:a})}}if(this.storeOrderby==''){}else{this.store.sort(this.storeOrderby,this.storeOrder)}if(this.showCal_tbar){var btntoday=this.topToolbar.items.items[0];btntoday.setHandler(this.setCurrentDate,this);var b=this.topToolbar.items.items[2];var c=this.topToolbar.items.items[3];var d=this.topToolbar.items.items[4];var e=this.topToolbar.items.items[5];if(!this.mview){b.setVisible(false)}else{b.setVisible(true)}if(!this.dview){d.setVisible(false)}else{d.setVisible(true)}if(!this.wview){c.setVisible(false)}else{c.setVisible(true)}if(!this.sview){e.setVisible(false)}else{e.setVisible(true)}b.addListener('click',function(){this.changeView('month')},this);d.addListener('click',function(){this.changeView('day')},this);c.addListener('click',function(){this.changeView('week')},this);e.addListener('click',function(){this.changeView('schedule')},this)}if(this.header&&this.tools.refresh){if(this.refreshAction=='view'){this.tools.refresh.addListener('click',this.refreshCalendarView,this)}else{this.tools.refresh.addListener('click',function(){this.store.reload()},this)}}if(this.dateSelector&&this.showCal_tbar){this.selector_dateMenu.picker.startDay=this.pickerStartDay;this.selector_dateMenu.picker.todayText=e2cs.cal_locale.todayLabel;this.selector_dateMenu.picker.todayTip=e2cs.cal_locale.todayToolTip;this.selector_dateMenu.picker.monthNames=e2cs.cal_locale.monthtitles;this.selector_dateMenu.picker.dayNames=e2cs.cal_locale.daytitles;this.selector_dateMenu.picker.setValue(this.currentdate);this.selector_dateMenu.addListener('select',this.selectdatefromSelector,this);this.btn_selector={id:this.id+'-btn_dateselector',cls:'x-btn-text-icon',text:e2cs.cal_locale.dateSelectorText,icon:this.dateSelectorIcon,tooltip:e2cs.cal_locale.dateSelectorTooltip,menu:this.selector_dateMenu};this.tbar_calendar.addButton(this.btn_selector)}if(this.ownerCt==undefined){if(this.currentView=='month'){this.viewmonth.render()}if(this.currentView=='week'){this.viewweek.render()}if(this.currentView=='day'){this.viewday.render()}if(this.currentView=='schedule'){this.viewscheduler.render()}}else{if(this.currentView=='month'){this.viewmonth.render()}if(this.currentView=='week'){this.viewweek.render()}if(this.currentView=='day'){this.viewday.render()}if(this.currentView=='schedule'){this.viewscheduler.render()}}this.doLayout();this.viewready=true;tmpobj=this;if(this.monitorBrowserResize){Ext.EventManager.onWindowResize(function(){tmpobj.refreshCalendarView()})}},refreshCalendarView:function(a){if(this.rendered){if(this.storeOrderby==''){}else{this.store.sort(this.storeOrderby,this.storeOrder)}if(this.currentView=='month'){this.viewmonth.render()}if(this.currentView=='week'){this.viewweek.render()}if(this.currentView=='day'){this.viewday.render()}if(this.currentView=='schedule'){this.viewscheduler.render()}this.doLayout();this.fireEvent("onRefresh",this)}},setNewDate:function(a){if(this.fireEvent("beforeChangeDate",a,this)==false){this.selector_dateMenu.picker.setValue(this.currentdate);return false}if(this.storeOrderby==''){}else{this.store.sort(this.storeOrderby,this.storeOrder)}this.currentdate=new Date(a);this.selector_dateMenu.picker.setValue(this.currentdate);if(this.currentView=='month'){this.viewmonth.render()}if(this.currentView=='week'){this.viewweek.render()}if(this.currentView=='day'){this.viewday.render()}if(this.currentView=='schedule'){this.viewscheduler.render()}this.doLayout();this.fireEvent("afterChangeDate",this.currentdate,this)},setCurrentDate:function(){this.setNewDate(Date())},changeView:function(a,b){var c=a;var d=this.currentView;if(c==d){return false}if(this.fireEvent("beforeChangeView",c,this.currentView,this)==false){return false}if(a=='month'){if(this.viewmonth==null||this.viewmonth==undefined){return false}else{this.currentView='month';this.viewmonth.render()}}else if(a=='week'){if(this.viewweek==null||this.viewweek==undefined){return false}else{this.currentView='week';this.viewweek.render()}}else if(a=='day'){if(this.viewday==null||this.viewday==undefined){return false}else{this.currentView='day';this.viewday.render()}}else if(a=='schedule'){if(this.viewscheduler==null||this.viewscheduler==undefined){return false}else{this.currentView='schedule';this.viewscheduler.render()}}else{return false}this.fireEvent("onChangeView",c,d,this)},selectdatefromSelector:function(a,b){this.setNewDate(b)},getCurrentDate:function(){return this.currentdate},getViewMonth:function(){if(!this.viewmonth){this.viewmonth=new Ext.ECalendar.monthview(this.mview)}return this.viewmonth},getViewDay:function(){if(!this.viewday){this.viewday=new Ext.ECalendar.dayview(this.dview)}return this.viewday},getViewWeek:function(){if(!this.viewweek){this.viewweek=new Ext.ECalendar.weekview(this.wview)}return this.viewweek},getViewShedule:function(){if(!this.viewscheduler){this.viewscheduler=new Ext.ECalendar.scheduleview(this.sview)}return this.viewscheduler},getCalendarMonth:function(){return(this.currentdate.getMonth()+1)},getCalendarYear:function(){return(this.currentdate.getFullYear())},getCalendarDay:function(){return(this.currentdate.getUTCDate())},getCalendarWeekDay:function(a){if(a=='str'){return Date.dayNames[this.currentdate.getDay()]}else{return(this.currentdate.getDay())}},getRangeofMonth:function(a){var b=new Date(dateval);var c=b.getFirstDayOfMonth()-this.startDay;var d=b.getDaysInMonth();if(b.getMonth()==1){if((b.getFullYear()%4==0&&b.getFullYear()%100!=0)||b.getFullYear()%400==0){d=29}}if(c<0){c=7+(c)}var e=new Date((dateval.getMonth()+1)+'/1/'+dateval.getFullYear()).add(Date.DAY,(c*-1));var f=c;startmonthdate=new Date(b.format('m')+'/01/'+b.format('Y'));for(var g=0;g<d;g++){if(f>=7){f=0}var h=new Date(startmonthdate).add(Date.DAY,g);f+=1}var i=new Date((dateval.getMonth()+1)+'/1/'+dateval.getFullYear()).add(Date.DAY,(d));var j=i.getDay();if(f<7){var k=0;for(var l=f;l<7;l++){k=k+1;var m=new Date(h).add(Date.DAY,k)}}var toretn=[e,m];return toretn},getDateRangeOfWeekByDate:function(a,b){var c=new Date(b).getDay();if(a==1){c=((c==0)?6:c-1);var d=new Date(b.add(Date.DAY,-c).format('m/d/Y')+' 00:00:00');var e=new Date(b.add(Date.DAY,-c+6).format('m/d/Y')+' 23:59:59')}else if(a==0){if(c==0){var d=new Date(b.add(Date.DAY,0).format('m/d/Y')+' 00:00:00');var e=new Date(b.add(Date.DAY,6).format('m/d/Y')+' 23:59:59')}else{var d=new Date(b.add(Date.DAY,-(c)).format('m/d/Y')+' 00:00:00');var e=new Date(d.add(Date.DAY,6).format('m/d/Y')+' 23:59:59')}}else{if(c==6){var d=new Date(b.add(Date.DAY,0).format('m/d/Y')+' 00:00:00');var e=new Date(b.add(Date.DAY,6).format('m/d/Y')+' 23:59:59')}else{var d=new Date(b.add(Date.DAY,-(c+1)).format('m/d/Y')+' 00:00:00');var e=new Date(d.add(Date.DAY,6).format('m/d/Y')+' 23:59:59')}}return[d,e]},getDateRangeOfWeek:function(a){var b=new Date();numOfdaysPastSinceLastMonday=eval(b.getDay()-1);b.setDate(b.getDate()-numOfdaysPastSinceLastMonday);var c=b.getWeekOfYear();var d=eval(a-c);b.setDate(b.getDate()+eval(7*d));var e=new Date((b.getMonth()+1)+"/"+b.getDate()+"/"+b.getFullYear());b.setDate(b.getDate()+6);var f=new Date((b.getMonth()+1)+"/"+b.getDate()+"/"+b.getFullYear());return[e,f]},dateDiff:function(a,b,c){if(typeof a=='number'){a=new Date(a)}if(typeof b=='number'){b=new Date(b)}if(a.format('m/d/Y H:i:s')==b.format('m/d/Y H:i:s')){return 0}var d=b.getFullYear()-a.getFullYear();var e=(b.getMonth()-a.getMonth())+(d*12);var f=b.getTime()-a.getTime();var g=f/1000;var h=g/60;var i=h/60;var j=i/24;var k=j/7;var l=0;with(e2cs.dateParts){switch(c){case YEAR:l=d;break;case QUARTER:var m=a.getMonth();var n=b.getMonth();var o=Math.floor(m/3)+1;var p=Math.floor(n/3)+1;p+=(d*4);l=p-o;break;case MONTH:l=e;break;case WEEK:l=parseInt(k);break;case DAY:l=j;break;case WEEKDAY:var q=Math.round(j);var r=parseInt(q/7);var s=q%7;if(s==0){q=r*5}else{var t=0;var u=a.getDay();var v=b.getDay();r=parseInt(q/7);s=q%7;var w=new Date(a);w.setDate(w.getDate()+(r*7));var x=w.getDay();if(j>0){switch(true){case u==6:t=-1;break;case u==0:t=0;break;case v==6:t=-1;break;case v==0:t=-2;break;case(x+s)>5:t=-2;break;default:break}}else if(j<0){switch(true){case u==6:t=0;break;case u==0:t=1;break;case v==6:t=2;break;case v==0:t=1;break;case(x+s)<0:t=2;break;default:break}}q+=t;q-=(r*2)}l=q;break;case HOUR:l=i;break;case MINUTE:l=h;break;case SECOND:l=g;break;case MILLISECOND:l=f;break;default:break}}return Math.round(l)},getInnerHeight:function(){if(this.ownerCt!=undefined){if(this.ownerCt.ctype&&this.ownerCt.ctype=="Ext.Component"){return this.ownerCt.getInnerHeight()-(this.el?this.el.getMargins("tb"):0)}}return this.height},getOtherTasksWx:function(a,b,c,d){var e=0;var f=0;for(var i=0;i<a.length;++i){var g=new Date(a[i][this.fieldsRefer.startdate]);var h=new Date(a[i][this.fieldsRefer.enddate]);if(d>g&&c<h){++e}var s=a[i][this.fieldsRefer.subject];if(b==s&&this.dateDiff(g,c,e2cs.dateParts.MINUTE)==0&&this.dateDiff(h,d,e2cs.dateParts.MINUTE)==0){f=e-1}}return{number:e,taskIdx:f*100/e}},collideevents:function(a,b){var c=new Date(a.startdate),d=new Date(a.enddate);var e=new Date(b.startdate),f=new Date(b.enddate);var g=0;if(c>=e&&c<f){g+=1}else if(e>=c&&f<=d){g+=1}else if(e<d&&f>d){g+=1}return g},overlapEventsdata:function(a,b,c,d,e){var f=new Ext.data.JsonStore({storeId:'tmpstore',root:'datarecs',idProperty:'recid',fields:[{name:'recid'},{name:'startdate'},{name:'enddate'}]});f.loadData(b);f.sort('startdate','ASC');var g=0,h=f.getCount(),k=0,l='';if(h==0){return{number:0,taskIdx:0}}if(h==1){return{taskid:a.recid,number:1,ancho:100,left:0,collideWith:'',createdtask:c}}var m=0,n=0;if(h>1){for(var i=0;i<h;i++){if(f.getAt(i).data.recid==a.recid){g+=1}else{var o=this.collideevents(a,f.getAt(i).data);g+=o;if(o){l+=''+f.getAt(i).data.recid+','}var p=11}}if(l.length>1){l=l.substr(0,(l.length-1))}if(l.indexOf(',')>=0){var prevtaskchecking=null;var colissionels=l.split(',');var tmptsks=[];for(var z=0;z<colissionels.length;z++){for(var i=0;i<h;i++){if(f.getAt(i).data.recid==colissionels[z]){tmptsks.push(f.getAt(i).data);break}}}var currenttask=tmptsks[0];for(var i=0;i<tmptsks.length;i++){if(tmptsks[i].recid!=currenttask.recid){if(tmptsks[i].recid==a.recid){var flagadd=true}else{var flagadd=false}var o=this.collideevents(currenttask,tmptsks[i]);if(!o||o==0){g-=1}else{g+=0}}}}if(d<0){m=0;n=0}else{n=0;for(var j=0;j<e.length;j++){if(e[j].collideWith==a.recid||e[j].collideWith.indexOf(a.recid+',')>=0||e[j].collideWith.indexOf(','+a.recid)>=0){if(e[j].left==0){n=1;m=e[j].ancho}else{m+=e[j].ancho}}var p=11}}}if(n==0){m=0}f.destroy();return{taskid:a.recid,number:h,ancho:100/g,left:m,collideWith:l,createdtask:c}}});Ext.reg('e2cs_calendar',Ext.ECalendar);
